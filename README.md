# Проектная работа: диплом

Платежная система
-

1 прием платежей  
2 лог транзакций  
3 оплата  
4 повторяющиеся платежи (подписка)   

Основная единицей системы транзакция.  

модель:   

user   
reason   
amount   
datetime   
balance???   

Прием платежей
-


• Регистрируемся в платежной системе; 

• Получаем API ключи; 

• Устанавливаем соответствующий пакет; 

• Реализовываем форму оплаты; 

• Реализовываем функцию зачисления средств на баланс после оплаты.

Создаем платеж:
```
{
    "value": 1342.00,
    "currency": "RUB",
    "description": "Оплата подписки"
}
```

Отправляем POST-запрос на адрес:
```
http://127.0.0.1:8000/api/v1/payment
```

В ответ получаем **confirmation_url**
по которому должен проследовать пользователь и произвести оплату



Списание средств 
-


Перед операцией необходимо проверять,  
каким будет баланс счета после проведения операции.   
Это необходимо делать для того, чтобы не обслуживать пользователя “в кредит”,  
что особенно важно, когда транзакции выполняются на большие суммы.   

Повторяющиеся списания
-
 
У нас есть потребность каждый час (назовет это “биллинг-период”)   
снимать с пользователя определенную сумму в соответствии с его тарифным планом.   
Для реализации этого механизма мы используем celery – написан task, который выполняется каждый час.   
Логика в этом моменте получилась сложная, так как необходимо учитывать много факторов: 

• между выполнениями задачи в celery никогда не пройдет ровно час (биллинг-период); 

• пользователь пополняет свой баланс (он становится >0) и   
получает доступ к услугам между биллинг-периодами, снимать за период было бы нечестно;   

• пользователь может поменять тариф в любое время; 

• celery может по каким-либо причинам перестать выполнять задачи  


в модель User добавить поле 
last_hourly_billing, где указываем время последней повторяющиеся операции.  
Логика работы: 

• Каждый биллинг-период мы смотрим время last_hourly_billing и   
списываем сумму согласно тарифному плану, затем обновляем поле last_hourly_billing; 

• При смене тарифного плана мы списываем сумму по прошлому тарифу и обновляем поле last_hourly_billing; 

• При активации услуги мы обновляем поле last_hourly_billing.

Безопасность
-
Шифрование???  

JWT token - payload user_id

Стати
-
https://habr.com/ru/company/bitcalm/blog/234861/  
https://fingers.by/blog/how-to-integrate-a-payment-gateway-part-1 часть 1  
https://fingers.by/blog/how-to-integrate-a-payment-gateway-part-2 часть 2  
https://stripe.com/docs/api?lang=python Stripe документация  
https://medium.com/@mishraranjeet122/integrate-stripe-payment-with-a-card-in-python-e90989d39bca Stripe интеграция
https://habr.com/ru/post/580866/ Как настроить SQLAlchemy, SQLModel и Alembic для асинхронной работы с FastAPI